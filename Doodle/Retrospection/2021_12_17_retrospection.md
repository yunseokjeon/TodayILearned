# 2021년 12월 17일 회고

어제 서버의 전략 시뮬레이션 기능을 구현하기 위해 300 줄 정도의 코드를 작성하였다. 어떤 클래스는 한 번에 100줄 넘게 작성하려다 보니 많은 신경을 쓰게 되었고, 힘도 들었다. 작성해야 할 코드의 양이 많아서라기 보다, 한줄 한줄 작성할 때마다 고려해야 할 요소들이 많은 점 때문에 힘이 들었다. 중요한 비지니스 로직을 구현한다면 이런 기분일까?

## NaN

어떤 전략의 수익률 분포가 주어졌을 때, 어느 정도의 자본을 베팅해야 할까? 10%? 50%? 혹은 4배의 레버리지를 사용해야 할까? 이에 대한 답을 제시해 주는 것이 Kelly criterion이다.

Y = E * ln(1 + f * X)

이 식에서 최적 베팅 비율 f를 찾는 것이 켈리 기준의 목표이다. 

나도 어제 기능을 구현하면서, 계산에 이 공식을 사용하였다. 전략을 시뮬레이션 하면서, 자본의 성장을 기록하고, 이를 바탕으로 수익률 분포를 알아낸 다음, 최적 베팅 비율을 계산을 해보았다.

그런데 어찌된 일인지 f의 변화에 따른 결과값이 모두 NaN으로 나오는 것이었다. 버그가 생겨도 기묘하게 값이 튈 수는 있어도 NaN이라니. 

문제의 원인은 log 함수의 특성 때문이었다. log 0은 음의 무한대로 향하게 되고, 컴퓨터가 음의 무한대를 연산할 수 없으니 NaN이 나온 것이었다. 

궁여지책으로 다음과 같이 처리하였다.
```Java
    if (earningsRates.get(i) <= -0.5) {
        y += (((double) 1 / (double) earningsRates.size())) * Math.log(1 + f * 0);
    } else {
        y += ((double) 1 / (double) earningsRates.size()) * Math.log(1 + f * earningsRates.get(i));
    }
```
문제는 이렇게 하면 정확한 계산 결과를 얻을 수 없어서 일부 수정이 필요할 것 같다. 

